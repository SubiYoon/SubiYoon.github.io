# reactive( )

# Vue reactive function

```jsx
const targetMap = new WeakMap() // targetMap stores the effects that each object should re-run when it's updated
let activeEffect = null // The active effect running

function track(target, key) {
  if (activeEffect) {
    // <------ Check to see if we have an activeEffect
    // We need to make sure this effect is being tracked.
    let depsMap = targetMap.get(target) // Get the current depsMap for this target
    if (!depsMap) {
      // There is no map.
      targetMap.set(target, (depsMap = new Map())) // Create one
    }
    let dep = depsMap.get(key) // Get the current dependencies (effects) that need to be run when this is set
    if (!dep) {
      // There is no dependencies (effects)
      depsMap.set(key, (dep = new Set())) // Create a new Set
    }
    dep.add(activeEffect) // Add effect to dependency map
  }
}

function trigger(target, key) {
  const depsMap = targetMap.get(target) // Does this object have any properties that have dependencies (effects)
  if (!depsMap) {
    return
  }
  let dep = depsMap.get(key) // If there are dependencies (effects) associated with this
  if (dep) {
    dep.forEach((effect) => {
      // run them all
      effect()
    })
  }
}

function reactive(target) {
  const handler = {
    get(target, key, receiver) {
      let result = Reflect.get(target, key, receiver)
      track(target, key) // If this reactive property (target) is GET inside then track the effect to rerun on SET
      return result
    },
    set(target, key, value, receiver) {
      let oldValue = target[key]
      let result = Reflect.set(target, key, value, receiver)
      if (result && oldValue != value) {
        trigger(target, key) // If this reactive property (target) has effects to rerun on SET, trigger them.
      }
      return result
    },
  }
  return new Proxy(target, handler)
}

function effect(eff) {
  activeEffect = eff
  activeEffect()
  activeEffect = null
}

let product = reactive({ price: 5, quantity: 2 })
let salePrice = 0
let total = 0

effect(() => {
  total = product.price * product.quantity
})
effect(() => {
  salePrice = product.price * 0.9
})

console.log(
  `Before updated quantity total (should be 10) = ${total} salePrice (should be 4.5) = ${salePrice}`
)
product.quantity = 3
console.log(
  `After updated quantity total (should be 15) = ${total} salePrice (should be 4.5) = ${salePrice}`
)
product.price = 10
console.log(
  `After updated price total (should be 30) = ${total} salePrice (should be 9) = ${salePrice}`
)
```

### ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë°©ë²•

- WeakMap - ê°ì²´ë¥¼ keyë¡œ ì‚¬ìš©í•˜ëŠ” JavaScript Map

```jsx
const targetMap = new WeakMap() // targetMap stores the effects that each object should re-run when it's updated

function track(target, key) {
  // We need to make sure this effect is being tracked.
  let depsMap = targetMap.get(target) // Get the current depsMap for this target

  if (!depsMap) {
    // There is no map.
    targetMap.set(target, (depsMap = new Map())) // Create one
  }

  let dep = depsMap.get(key) // Get the current dependencies (effects) that need to be run when this is set
  if (!dep) {
    // There is no dependencies (effects)
    depsMap.set(key, (dep = new Set())) // Create a new Set
  }

  dep.add(effect) // Add effect to dependency map
}

function trigger(target, key) {
  const depsMap = targetMap.get(target) // Does this object have any properties that have dependencies (effects)
  if (!depsMap) {
    return
  }

  let dep = depsMap.get(key) // If there are dependencies (effects) associated with this
  if (dep) {
    dep.forEach(effect => {
      // run them all
      effect()
    })
  }
}

let product = { price: 5, quantity: 2 }
let total = 0
let effect = () => {
  total = product.price * product.quantity
}

// ê°ì²´ë¥¼ í‚¤ë¡œ, ê°ì²´ì˜ quantitiy êµ¬ë…
track(product, 'quantity')
effect()
console.log(total) // --> 10

product.quantity = 3
trigger(product, 'quantity')
console.log(total) // --> 15
```

# **Proxy and Reflect**

ë°˜ì‘ì„± ê°ì²´ì—ì„œ get ë° set ë©”ì„œë“œë¥¼ hooking(ë˜ëŠ” ë¦¬ìŠ¤ë‹)í•˜ëŠ” ë°©ë²•ì´ í•„ìš”í•©ë‹ˆë‹¤.

- GET ì†ì„± => í˜„ì¬ íš¨ê³¼ë¥¼ ì¶”ì í•´ì•¼ í•©ë‹ˆë‹¤.
- **SET ì†ì„± => ì´ ì†ì„±ì— ëŒ€í•´ ì¶”ì ëœ ì¢…ì†ì„±(effect)ì„ íŠ¸ë¦¬ê±°í•´ì•¼ í•©ë‹ˆë‹¤.**

ì´ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì„ ì´í•´í•˜ëŠ” ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ”

**Vue 3ì—ì„œ ES6 Reflect ë° Proxyë¥¼ ì‚¬ìš©í•˜ì—¬ GET ë° SET í˜¸ì¶œì„ ê°€ë¡œì±„ëŠ” ë°©ë²•ì„ ì´í•´í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.**

Vue 2ì—ì„œëŠ” ES5 Object.definePropertyë¡œ ì´ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.

ì´ëŠ” ê¸°ì¡´ ê°ì²´ë¥¼ ì§ì ‘ ì¡°ì‘í•˜ë©°, í”„ë¡ì‹œì™€ ë‹¤ë¥´ê²Œ ë°˜ì‘í˜•ì„ ë ˆì´ì§€í•˜ê²Œ êµ¬í˜„í•˜ê¸° ì–´ë µë‹¤ëŠ” ë‹¨ì ì´ ìˆì—ˆìŠµë‹ˆë‹¤.

### **Understanding ES6 Reflect**

ê°ì²´ ì†ì„±ì„ ë‹¤ìŒê³¼ ê°™ì´ print í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```jsx
let product = { price: 5, quantity: 2 }
console.log('quantity is ' + product.quantity)
// orconsole.log('quantity is ' + product['quantity'])
```

ê·¸ëŸ¬ë‚˜ Reflectë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ì˜ ê°’ì„ GETí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

Reflectë¥¼ ì‚¬ìš©í•˜ë©´ ê°ì²´ì˜ ì†ì„±ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìœ„ì—ì„œ ì“´ ê²ƒì„ ìˆ˜í–‰í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì…ë‹ˆë‹¤.

```jsx
console.log('quantity is ' + Reflect.get(product, 'quantity'))
```

Reflectë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ë­˜ê¹Œìš”?

### **Understanding ES6 Proxy**

í”„ë¡ì‹œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë©”ì„œë“œì˜ ì‹¤í–‰ì„ ëŒ€ìƒ ê°ì²´ì— ìœ„ì„í•˜ëŠ” Placeholderì…ë‹ˆë‹¤.

ë”°ë¼ì„œ ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ quantityì˜ getì„ ë‹¤ë¥¸ ê°ì²´ì— ìœ„ì„í•©ë‹ˆë‹¤.

```jsx
let product = { price: 5, quantity: 2 }
let proxiedProduct = new Proxy(product, {})
console.log(proxiedProduct.quantity)
```

**í”„ë¡ì‹œ ê°ì²´ì˜ {}ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‘ ë²ˆì§¸ ì¸ìˆ˜ì— ì£¼ëª©í•˜ì„¸ìš”**

ì´ê²ƒì„ í•¸ë“¤ëŸ¬ë¼ê³  í•˜ë©° get ë° set í˜¸ì¶œì„ ê°€ë¡œì±„ëŠ” ê²ƒê³¼ ê°™ì´

í”„ë¡ì‹œ ê°ì²´ì˜ ë™ì‘ì„ ì‚¬ìš©ì ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì´ëŸ¬í•œ ì¸í„°ì…‰í„° ë©”ì„œë“œë¥¼ íŠ¸ë©(trap)ì´ë¼ê³  í•©ë‹ˆë‹¤.**

> í”„ë¡ì‹œ ìƒì„±ìì˜ ë‘ë²ˆì§¸ ì¸ì í•¸ë“¤ëŸ¬ ê°ì²´ì˜ ë©”ì„œë“œ : íŠ¸ë©
> 

í•¸ë“¤ëŸ¬ì—ì„œ get íŠ¸ë©ì„ ì„¤ì •í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```jsx
let product = { price: 5, quantity: 2 }

let proxiedProduct = new Proxy(product, {
  get() {
    console.log('Get was called')
    return 'Not the value'
  }
})

console.log(proxiedProduct.quantity)
```

ì½˜ì†”ì€ ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤.

```jsx
Get was called
Not the value
```

ì¦‰ ìš°ë¦¬ëŠ” ëŒ€ìƒ ê°ì²´ì˜ getì´ ë¦¬í„´í•˜ëŠ” ê°’ì„ ì¬ì •ì˜ í–ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” ì‹¤ì œ ê°ì²´ì˜ ê°’ì„ ë¦¬í„´í•´ì•¼ í•©ë‹ˆë‹¤.

```jsx
let product = { price: 5, quantity: 2 }

let proxiedProduct = new Proxy(product, {
  get(target, key) {// <--- The target (our object) and key (the property name)console.log('Get was called with key = ' + key)
    return target[key]
  }
})

console.log(proxiedProduct.quantity)
```

getì—ëŠ” ê°ì²´(ì˜ˆ:product) ëŒ€ìƒ(**target**)ê³¼ ê°ì²´ì—ì„œ ì¡°íšŒí•˜ê³ ì í•˜ëŠ” ì†ì„±(**key**) ë‘ ê°€ì§€ ì¸ìê°€ ìˆìŠµë‹ˆë‹¤.

ë¡œê·¸ ì¶œë ¥ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```jsx
Get was called with key = quantity

2
```

ì—¬ê¸°ì—ì„œ Reflectë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶”ê°€ ì¸ìˆ˜(receiver)ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```jsx
let product = { price: 5, quantity: 2 }
let proxiedProduct = new Proxy(product, {
  get(target, key, receiver) {// <--- notice the receiverconsole.log('Get was called with key = ' + key)
    return Reflect.get(target, key, receiver)// <----
  }
})
```

getì—ëŠ” Reflect.getì— ì¸ìˆ˜ë¡œ ë³´ë‚´ëŠ”Â **receiver**ë¼ëŠ” ì¶”ê°€ ë§¤ê°œë³€ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤.

**ì´ë ‡ê²Œ í•˜ë©´ target ê°ì²´ê°€ ë‹¤ë¥¸ ê°ì²´ì—ì„œ ê°’/í•¨ìˆ˜ë¥¼ ìƒì†ë°›ì•˜ì„ ë•Œì—ë„ ì ì ˆí•œ this ê°’ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.**

ì´ê²ƒì´ ìš°ë¦¬ê°€ í•­ìƒ Proxy ë‚´ë¶€ì—ì„œ Reflectë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ì…ë‹ˆë‹¤.

ê·¸ë˜ì„œ ìš°ë¦¬ê°€ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ëŠ” ì›ë˜ ë™ì‘(get)ì„ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ setter ë©”ì„œë“œë¥¼ ì¶”ê°€í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë³„ ì°¨ì´ëŠ” ì—†ìŠµë‹ˆë‹¤.

```jsx
let product = { price: 5, quantity: 2 }

let proxiedProduct = new Proxy(product, {
  get(target, key, receiver) {
    console.log('Get was called with key = ' + key)
    return Reflect.get(target, key, receiver)
  }
  set(target, key, value, receiver) {
    console.log('Set was called with key = ' + key + ' and value = ' + value)
    return Reflect.set(target, key, value, receiver)
  }
})

proxiedProduct.quantity = 4
console.log(proxiedProduct.quantity)
```

setì€ ëŒ€ìƒ(product)ì„ ì„¤ì •í•˜ê¸° ìœ„í•´ ê°’ì„ ë°›ëŠ” Reflect.setì„ ì‚¬ìš©í•œë‹¤ëŠ” ì ì„ ì œì™¸í•˜ë©´ getê³¼ ë§¤ìš° ìœ ì‚¬í•©ë‹ˆë‹¤.

ì˜ˆìƒëŒ€ë¡œ ì¶œë ¥ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```jsx
Set was called with key = quantity and value = 4

Get was called with key = quantity

4
```

### ì°¸ê³ ì‚¬í•­

### <reactive( ) êµ¬í˜„>

[Vue3ì˜ ë°˜ì‘ì„± ì™„ë²½ ì´í•´ 1í¸ : ì¢…ì†ì„± ì¶”ì ](https://itchallenger.tistory.com/m/815)

### <JavaScriptì˜ Proxyì™€ Reflect>

[ğŸ“š ìë°”ìŠ¤í¬ë¦½íŠ¸ Proxy & Reflect ê³ ê¸‰ ê¸°ë²•](https://inpa.tistory.com/entry/JS-ğŸ“š-ìë°”ìŠ¤í¬ë¦½íŠ¸-Proxy-Reflect-ê³ ê¸‰-ê¸°ë²•)

[Vue3ì˜ ë°˜ì‘ì„± ì™„ë²½ ì´í•´ 1í¸ : ì¢…ì†ì„± ì¶”ì ](https://itchallenger.tistory.com/m/815)