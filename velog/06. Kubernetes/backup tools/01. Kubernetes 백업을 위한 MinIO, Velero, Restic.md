---
tags:
  - Kubernetes
  - Backup
  - MinIO
  - Velero
  - Restic
---
## 서두
우선 이 과정은 처음에는 A서버에 있는 Kubernetes환경을 그대로 백업해 B서버에 그대로 심어보려는 작업으로 시작되었다.

하지만, 전체 데이터를 통으로 떠와서 작업하는 방법은 문제가 있는거 같다. 예를 들면 `rook-ceph`의 경우 물리적으로 사용되는 `osd`가 `running`상태로 변경되지 않는다...

### 시행착오
1. `Resource`내용을 그대로 카피하기 때문에 `pvc`와 `pv`의 설정이 한몫한다.
	- 그래서 다른 방법으로 `Dynamic StorageClass`를 이용한 동적으로 `pv`를 생성하게 작업도 시도해보았지만 pvc에 설정된 `StorageClassName`이 변경되질 않았다.
	- 아직 정확한 이유를 밝히지는 못함.
2. `rook-ceph`를 `velero`로 백업하지 않고 먼저 설치한 후에 `rook-ceph`를 제외한 `Resource`들을 적용시켰을 경우 `rook-ceph`가 정상동작하나 pv를 자동으로 적용시키지 못했다.
	- `csi`관련 `secret`이나 이런것들이 생성이 되질 않았는데, 이 문제인가 싶기도함.
	- **차 후 더 시도해 볼 가치가 있음**
3. `Ceph`의 `Mirroring`을 통한 방법을 최정적으로 채택

## MinIO
### 용도
- S3기반의 CSI를 사용하기 위한 백업용
- CSI를 사용하기 위한 오픈소스

### Server 설치
#### Install Docs 
- https://docs.min.io/enterprise/aistor-object-store/

#### MinIO를 사용하기 위한 환경 변수 설정
- 계정 : 최소 3글자 이상
- 비밀번호 : 최소 8글자 이상
```bash title:minio.conf
# vi ~/minio.conf
MINIO_VOLUMES="/data/k8s"
MINIO_ROOT_USER=test
MINIO_ROOT_PASSWORD=test2025
MINIO_ACCESS_KEY=test
MINIO_SECRET_KEY=test2025
```

#### minio.service파일을 생성해 시스템이 관리할 수 있도록 설정
```bash title:minio.service
# vi /etc/systemd/system/minio.service
[Unit]
Description=MinIO
Documentation=https://min.io/docs/minio/linux/index.html
Wants=network-online.target
After=network-online.target
AssertFileIsExecutable=/usr/local/bin/minio

[Service]
# WorkingDirectory=/usr/local

#User=ulim
#Group=ulim
#ProtectProc=invisible

# "=-" : 해당 파일이 없어도 오류로 간주하지 않음
# address는 파일을 전송할 포트 console-address는 웹 대쉬보드 포트
EnvironmentFile=/etc/minio/minio.conf
ExecStartPre=/bin/bash -c "if [ -z \"${MINIO_VOLUMES}\" ]; then echo \"Variable MINIO_VOLUMES not set in /etc/default/minio\"; exit 1; fi"
ExecStart=/usr/local/bin/minio server --address :9000 --console-address :9001 ${MINIO_VOLUMES}

# MinIO RELEASE.2023-05-04T21-44-30Z adds support for Type=notify (https://www.freedesktop.org/software/systemd/man/systemd.service.html#Type=)
# This may improve systemctl setups where other services use `After=minio.server`
# Uncomment the line to enable the functionality
# Type=notify

# Let systemd restart this service always
Restart=always

# Specifies the maximum file descriptor number that can be opened by this process
LimitNOFILE=65536

# Specifies the maximum number of threads this process can create
TasksMax=infinity

# Disable timeout logic and wait until process is stopped
TimeoutStopSec=infinity
SendSIGKILL=no

[Install]
WantedBy=multi-user.target
```

#### service파일을 적용
```bash
sudo systemctl daemon-reload
sudo systemctl enable minio.service
sudo systemctl start minio.service
sudo systemctl status minio.service

# result
Oct 24 17:43:59 kube21 systemd[1]: Started minio.service - MinIO.
Oct 24 17:44:00 kube21 minio[8621]: INFO: WARNING: MINIO_ACCESS_KEY and MINIO_SECRET_KEY are deprecated.
Oct 24 17:44:00 kube21 minio[8621]:          Please use MINIO_ROOT_USER and MINIO_ROOT_PASSWORD
Oct 24 17:44:00 kube21 minio[8621]: MinIO Object Storage Server
Oct 24 17:44:00 kube21 minio[8621]: Copyright: 2015-2025 MinIO, Inc.
Oct 24 17:44:00 kube21 minio[8621]: License: GNU AGPLv3 - https://www.gnu.org/licenses/agpl-3.0.html
Oct 24 17:44:00 kube21 minio[8621]: Version: RELEASE.2025-09-07T16-13-09Z (go1.24.6 linux/amd64)
Oct 24 17:44:00 kube21 minio[8621]: API: http://192.168.0.114:9000  http://192.168.2.21:9000  http://10>
Oct 24 17:44:00 kube21 minio[8621]: WebUI: http://192.168.0.114:9001 http://192.168.2.21:9001 http://10>
Oct 24 17:44:00 kube21 minio[8621]: Docs: https://docs.min.io
```

#### Console 접속
- 9001번으로 접속하고 로그인하면 나오는 화면
![[Pasted image 20251027141236.png]]

### Client 설치
#### mc 설치
```bash
curl https://dl.min.io/client/mc/release/linux-amd64/mc -o mc
sudo mv mc /usr/local/bin
sudo chmod +x /usr/local/bin/mc
```

#### 접속 정보 생성
```bash
mc alias set ${사용할 alias명} ${server url(ex. https://api.acp.kt.co.kr:9000)} ${MINIO_ACCESS_KEY(ex. test)} ${MINIO_SECRET_KEY(ex. test2025)}
```

#### 예시
- 파일 복사
```bash
mc cp ${복사할 파일} ${사용할 alias명}/${bucket명}

# ex
mc cp ./test.yaml testServer/testBucket
```

---
## Velero
### 설치
#### CLI를 설치
```bash
wget https://github.com/vmware-tanzu/velero/releases/download/v1.17.0/velero-v1.17.0-linux-amd64.tar.gz

tar xzvf velero-v1.17.0-linux-amd64.tar.gz

sudo mv velero-v1.17.0-linux-amd64/velero /usr/local/bin/
```

#### 로그인에 필요한 정보를 작성
- `[default]`는 필수로 들어가야함
```bash title:"credientials-velero"
[default]
aws_access_key_id=minioadmin
aws_secret_access_key=minioadmin
```

#### CLI 이용해 설치한다.
```bash
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.3.0 \
  --bucket velero \
  --backup-location-config region=ap-northeast-2,s3ForcePathStyle="true",s3Url=http://192.168.2.11:9000 \
  --secret-file ./credentials-velero \
  --use-volume-snapshots=false \
  --use-node-agent  # 1.9이후 버전부터는 use-restic이 사라짐
```

### Restic을 적용
#### OPT-IN 방식(default)
- Pod `annoation`에 등록한 PV만 Restic을 적용시키는 방법
1. 등록하고 싶은 항목을 다음 `annotation`을 등록하는 방식으로 추가
```
kubectl -n <namespace> annotate pod/<pod-name> backup.velero.io/backup-volumes-includes=<pvc-name>
```

#### OPT-OUT 방식
- 기본적으로 모든 Pod을 Restic을 적용시키고 `annotation`을 통해 특정 PV를 제외하는 방법

1. 편집기에 진입
```bash
kubectl edit deployment velero -n velero
```

2. `spec.containers[0].args`에 다음 내용을 추가
```yaml
- --default-volumes-to-restic
```

```yaml
# 예시
spec:
  containers:
  - name: velero
    image: velero/velero:v1.13.1
    args:
      - server
      - --features=
      - --default-volumes-to-restic # 전부 Restic 적용
```

3. 제외하고 싶은 항목은 다음 `annotation`을 등록하는 방식으로 제외
```bash
kubectl -n <namespace> annotate pod/<pod-name> backup.velero.io/backup-volumes-excludes=<pvc-name>
```

### Velero CLI 자동 완성
```bash
sudo apt-get install bash-completion -y
vi ~/.bashrc
...
# bash-completion 활성화
if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
fi

# Velero 자동완성
source <(velero completion bash)
...
```

### 백업
#### 백업 실행
- 백업시 CRD도 포함시켜야 한다면 다음 옵션을 추가해야 한다.
	- `--include-cluster-resources=true`

```bash
# include-namespaces는 콤마를 기준으로 나뉜다. '*'를 입력하면 전부 백업
# exclude-namespaces는 콤마를 기준으로 나뉜다.
velero backup create ${BACKUP_NAME} --include-namespaces ns1,ns2,ns3 --exclude-namespaces ns4,ns5,ns6

# 예시
velero backup create v1 --include-namespaces '*' --exclude-namespaces openproject
```

- rook-ceph도 동기화시 아래 명령어
```bash
# --csi-snapshot-timeout 속성이 없을 수도 있음. 삭제하면 됨
velero backup create <백업-이름> \
  --include-namespaces <데이터가있는-네임스페이스> \
  --default-volumes-to-restic \
  --snapshot-volumes \
  --csi-snapshot-timeout 10m \ 
  --include-cluster-resources \
  --wait
```
#### Console 접속 화면
![[Pasted image 20251027180143.png]]

#### 백업 중 로그 확인
```bash
velero backup describe ${BACKUP_NAME} --details

# 예시
velero backup describe v1 --details

# Result
Name:         v1
Namespace:    velero
Labels:       velero.io/storage-location=default
Annotations:  velero.io/source-cluster-k8s-gitversion=v1.32.4
              velero.io/source-cluster-k8s-major-version=1
              velero.io/source-cluster-k8s-minor-version=32
...

Phase:  InProgress

Restic Backups:
  Completed:
    istio-system/grafana-65bfb5f855-bnlg4: storage
    istio-system/istiod-65648d9694-hvws7: local-certs
  In Progress:
    istio-system/prometheus-689cc795d4-tx7jh: storage-volume (62.14%)
```

### 복구
#### 백업 목록을 조회
```bash
velero backup get
```

#### 조회 결과를 반영하여 `name`으로 백업
```bash
velero restore create --from-backup ${BACKUP_NAME} --wait
```

- rook-ceph 데이터까지 동기화해서 백업
```bash
velero restore create <복원-이름> \
  --from-backup <백업-이름> \
  --restore-volumes \
  --wait
```

#### 백업 중 로그 확인
```bash
velero backup describe ${BACKUP_NAME} --details

# 예시
velero backup describe v1 --details
```

### PV생성
#### Dynamic StorageClass 생성
- PVC가 생성될 때마다 자동으로 PV를 생성
- PV설정을 세세하게 할 수 없어 단점이 명확함
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-storage
provisioner: kubernetes.io/aws-ebs   # 사용 환경에 따라 변경 가능 (예: gcePersistentDisk, csi.ceph.com 등)
parameters:
  type: gp3                          # EBS 유형 (gp2, gp3, io1 등)
  fsType: ext4                        # 파일 시스템 종류
  encrypted: "true"                   # 암호화 여부
reclaimPolicy: Delete                 # PVC 삭제 시 PV 삭제(Delete) or 보존(Retain)
volumeBindingMode: WaitForFirstConsumer  # PV 바인딩 시점
allowVolumeExpansion: true            # PVC 용량 확장 가능 여부
```

#### PV 직접 생성
- Velero나 Restic은 PV까지 생성해서 가져 오지 않기 때문에 직접 생성해서 사용

---
## Restic
- PV를 오브젝트 스토리지로 백업하는 오픈소스
