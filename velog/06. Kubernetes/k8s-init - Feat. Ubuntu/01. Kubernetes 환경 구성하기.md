---
tags:
  - FrameWork
  - Kubernetes
---
## ê°œë°œí™˜ê²½
Ubuntu 24.04.2 v42
k8s v1.32
cri-o v1.32
cilium v1.17

## ê°œë°œí™˜ê²½ ì…‹íŒ…

### ì‹œê°„ ì„¤ì •
- í•œêµ­ìœ¼ë¡œ ì‹œê°„ì„ ì„¤ì •
```bash
timedatectl set-timezone Asia/Seoul
sudo timedatectl set-ntp true
```

### ipìˆ˜ë™ì„¤ì •
- dhcpë¥¼ ì‚¬ìš©í•´ì„œ ipë¥¼ ìë™ í• ë‹¹ ë°›ìœ¼ë©´ ì°¨í›„ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì— ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.
- IPë¥¼ ê³ ì •ê°’ìœ¼ë¡œ ì…‹íŒ…í•˜ì—¬ ì´ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
```bash
cd /etc/netplan

sudo vi 50-cloud-init.yaml
```

```yaml title:"50-cloud-init.yaml"
network:
  version: 2
  ethernets:
    enp3s0:
      addresses:
        - 192.168.2.11/23
      dhcp4: true
      dhcp4-overrides:
        use-dns: true
        use-routes: true
      routes:
        - to: default
          via: 192.168.0.1
```


### hostnameë³€ê²½
- ì‚¬ìš©í•  hostnameìœ¼ë¡œ ë³€ê²½ kube01, kube02, kube03, ...
```bash
# vi /etc/hostname

kube01
```

- hostsì„¤ì •
```bash
# vi /etc/hosts
192.168.1.210 kube01
192.168.1.211 kube02
192.168.1.212 kube03
```

### ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜í™˜ê²½ ì…‹íŒ…
1. í™˜ê²½ ì…‹íŒ…
	- swapoff -a
	- swap í•­ëª© ì£¼ì„ ì²˜ë¦¬
	- `br_netfilter` ì»¤ë„ ëª¨ë“ˆ ë¡œë“œ
	- iptablesê°€ bridgeë¥¼ ì¸ì‹í•˜ë„ë¡ ì„¤ì •
	- SeLinux permissive or disabledì„¤ì •
	- ë°©í™”ë²½ í•´ì œ(íŠ¹ì • í¬íŠ¸ ì˜¤í”ˆì‹ íŒŒì¼ ìˆ˜ì •)

- ì•„ë˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•œ í›„ì— ë‹¤ìŒ ë™ì‘ì„ ì‹¤í–‰í•˜ì‹œë©´ í™˜ê²½ ì„¤ì •ì´ ì™„ë£Œë©ë‹ˆë‹¤.

```bash title:"env-setting.sh"
#!/bin/bash
set -e

# OS ê°ì§€
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
else
    echo "âŒ OS ì •ë³´ë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
fi

echo "ğŸ‘‰ Detected OS: $OS"

# Swap ë¹„í™œì„±í™” (ì¼ì‹œì )
echo "ğŸ”§ swapoff -a"
sudo swapoff -a

# fstabì—ì„œ swap ì£¼ì„ì²˜ë¦¬
echo "ğŸ”§ /etc/fstabì—ì„œ swap ì£¼ì„ ì²˜ë¦¬"
sudo cp /etc/fstab /etc/fstab.bak.k8s
sudo sed -i.bak '/\sswap\s/ s/^/#/' /etc/fstab

# br_netfilter ì„¤ì •
echo "ğŸ”§ br_netfilter ëª¨ë“ˆ ë¡œë“œ"
sudo modprobe br_netfilter
echo "br_netfilter" | sudo tee /etc/modules-load.d/k8s.conf

# sysctl ì„¤ì •
echo "ğŸ”§ sysctl ì„¤ì • ì ìš©"
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

sudo sysctl --system

# ë°©í™”ë²½ ë¹„í™œì„±í™”
if [[ "$OS" == "rhel" || "$OS" == "centos" || "$OS" == "fedora" ]]; then
    echo "ğŸ”§ firewalld ì¤‘ì§€"
    sudo systemctl disable --now firewalld || true
elif [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
    echo "ğŸ”§ ufw ì¤‘ì§€"
    sudo systemctl disable --now ufw || true
fi

# SELinux permissive ì„¤ì • (RedHat ê³„ì—´)
if [[ "$OS" == "rhel" || "$OS" == "centos" || "$OS" == "fedora" ]]; then
    echo "ğŸ”§ SELinux ì„¤ì •"
    sudo setenforce 0 || true
    sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config
fi

echo "âœ… ì¿ ë²„ë„¤í‹°ìŠ¤ ì‚¬ì „ ì¤€ë¹„ ì™„ë£Œ!"
```

```bash
sh env-setting.sh
```

2. CRI ì„¤ì¹˜
- cri-o ì„¤ì¹˜íŒŒì¼ì„ ë‹¤ìš´ë°›ì•„ ì„¤ì¹˜(v1.32.3)
- https://github.com/cri-o/cri-o/releases

```bash
sudo tar -xvf cri-o.amd64.v1.32.3.tar.gz

cd ./cri-o

sudo bash ./install

cd

sudo systemctl enable crio
sudo systemctl start crio
```

### ì¿ ë²„ë„¤í‹°ìŠ¤ì„¤ì¹˜
- CNIí”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
```bash
CNI_PLUGINS_VERSION="v1.1.1"
ARCH="amd64"
DEST="/opt/cni/bin"
sudo mkdir -p "$DEST"
curl -L "https://github.com/containernetworking/plugins/releases/download/${CNI_PLUGINS_VERSION}/cni-plugins-linux-${ARCH}-${CNI_PLUGINS_VERSION}.tgz" | sudo tar -C "$DEST" -xz
```

- ì“°ê¸°ê°€ ê°€ëŠ¥í•œ í´ë”ì— `DOWNLOAD_DIR`
```bash
DOWNLOAD_DIR="/usr/local/bin"
sudo mkdir -p "$DOWNLOAD_DIR"
```

- crictl ì„¤ì¹˜(adm, let ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ì¸í„°í˜ì´ìŠ¤(CRI)ì— í•„ìš”)
```bash
CRICTL_VERSION="v1.25.0"
ARCH="amd64"
curl -L "https://github.com/kubernetes-sigs/cri-tools/releases/download/${CRICTL_VERSION}/crictl-${CRICTL_VERSION}-linux-${ARCH}.tar.gz" | sudo tar -C $DOWNLOAD_DIR -xz
```

- adm, let, ctl ì„¤ì¹˜ ë° let systemd ì„œë¹„ìŠ¤ ì¶”ê°€
```bash
RELEASE="v1.32.4"
ARCH="amd64"
cd $DOWNLOAD_DIR
sudo curl -L --remote-name-all https://dl.k8s.io/release/${RELEASE}/bin/linux/${ARCH}/{kubeadm,kubelet,kubectl}
sudo chmod +x {kubeadm,kubelet,kubectl}

RELEASE_VERSION="v0.4.0"
curl -sSL "https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service" | sed "s:/usr/bin:${DOWNLOAD_DIR}:g" | sudo tee /etc/systemd/system/kubelet.service
sudo mkdir -p /etc/systemd/system/kubelet.service.d
curl -sSL "https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf" | sed "s:/usr/bin:${DOWNLOAD_DIR}:g" | sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
```

- let í™œì„±í™” ì‹œì‘
```bash
sudo systemctl enable --now kubelet
```

### ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì •
1. cgroupì„¤ì •
```bash
# í˜„ì¬ cgroup í™•ì¸
sudo stat -fc %T /sys/fs/cgroup
```

ìœ„ ê²°ê³¼ê°€ cgroup2fs -> cgroup v2 ì¼ ê²½ìš°, ì•„ë˜ ë‚´ìš©ì„ ì¶”ê°€í•´ì•¼í•©ë‹ˆë‹¤.

```bash
sudo vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

# ì¶”ê°€í• ë‚´ìš©
Environment="KUBELET_EXTRA_ARGS=--cgroup-driver=systemd"
```

ì„¤ì • ë°˜ì˜
```bash
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl restart kubelet
```

### kube-vip ì„¤ì¹˜
- kube-vipëŠ” ê°€ìƒ IPë¥¼ í•˜ë‚˜ ìƒì„±í•´ ëª¨ë“  íŠ¸ë˜í”½ì´ ê°€ìƒ IPë¥¼ ê±°ì³ì„œ í†µì‹  í•  ìˆ˜ ìˆê²Œí•©ë‹ˆë‹¤.
- ì—†ë‹¤ë©´ ì„¤ì¹˜í•´ì•¼ í•  ê²ƒë“¤
```bash
sudo apt-get -y install jq
sudo apt-get -y install podman
```

```bash
# VIPë¡œ ì‚¬ìš©í•  IP
export VIP=192.168.2.100
# Master Nodeì—ì„œ ì‚¬ìš©í•˜ëŠ” Interfaceëª…
export INTERFACE=enp3s0
export KVVERSION=$(curl -sL https://api.github.com/repos/kube-vip/kube-vip/releases | jq -r ".[0].name")
```

- aliasì¶”ê°€í•˜ê¸°
```bash
# podmanì˜ ê²½ìš°
alias kube-vip="sudo podman run --rm --network host --cap-add=NET_ADMIN --cap-add=NET_RAW ghcr.io/kube-vip/kube-vip:$KVVERSION"

# containerdì˜ ê²½ìš°
alias kube-vip="ctr image pull ghcr.io/kube-vip/kube-vip:$KVVERSION; ctr run --rm --net-host ghcr.io/kube-vip/kube-vip:$KVVERSION vip /kube-vip"

# dockerì˜ ê²½ìš°
alias kube-vip="docker run --network host --rm ghcr.io/kube-vip/kube-vip:$KVVERSION"
```

- ì„¤ì¹˜í•˜ê¸°(ARP)
```bash
kube-vip manifest pod \
    --interface $INTERFACE \
    --address $VIP \
    --controlplane \
    --services \
    --arp \
    --leaderElection | sudo tee /etc/kubernetes/manifests/kube-vip.yaml
```

- Cloud Provider ì„¤ì¹˜
```bash
kubectl apply -f https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml
```

- IPí• ë‹¹ ë²”ìœ„ Configmap ì„¤ì¹˜
```bash
kubectl create configmap -n kube-system kubevip --from-literal range-global=192.168.2.101-192.168.2.199
```
### master Node
#### ì¿ ë²„ë„¤íŠ¸ìŠ¤ ì´ˆê¸°í™”í•˜ê¸°
- inití›„ì— .kubeí´ë”ë¥¼ ë³µì„œí•˜ëŠ” ë‚´ìš©ì„ ë³µì‚¬í•˜ê±°ë‚˜ íŒŒì¼ë¡œ ë§Œë“¤ì–´ë‘¡ë‹ˆë‹¤.
```bash
sudo kubeadm init --control-plane-endpoint=192.168.2.100:6443 --pod-network-cidr=20.244.0.0/16 --upload-certs
```

#### Cilium ì„¤ì¹˜
1. ìš°ì„  Helmì„ í†µí•´ ì„¤ì¹˜í•˜ê°€ ìœ„í•´ Helmì„ ì„¤ì¹˜
```bash
sudo yum install -y helm
```

2. Client ì„¤ì¹˜
```bash
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
sudo rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
```

3. Cilium ì„¤ì¹˜
```bash
cilium install --version 1.17.3
```


#### Master Node í™œì„±í™” ì‹œí‚¤ê¸°
```bash
kubectl taint nodes kube21 node-role.kubernetes.io/control-plane:NoSchedule-
```

#### CILIUM's HUBBLE(Option)
- L3/L4/L7ì˜ì—­ íŠ¸ë˜í”½ ê·¸ë˜í”„ë¡œ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥

#### trouble shooting
- ì¬ì„¤ì •ì„ ìœ„í•´`kubeadm reset`ì„ ì§„í–‰í–ˆëŠ”ë°, `kubeadm join`ìœ¼ë¡œ ë‹¤ì‹œ ë¶™ì§€ ì•Šì„ê²½ìš°
```bash
# etcdì‰˜ë¡œ ì§„ì…
kubectl exec -it etcd-ë…¸ë“œëª… -n kube-system -- sh

# nodeë°ì´í„°ë¥¼ ì¡°íšŒ
etcdctl --cacert="/etc/kubernetes/pki/etcd/ca.crt" --cert="/etc/kubernetes/pki/etcd/server.crt" --key="/etc/kubernetes/pki/etcd/server.key" member list

# resetí–ˆë˜ nodeë°ì´í„° ì‚­ì œ
etcdctl --cacert="/etc/kubernetes/pki/etcd/ca.crt" --cert="/etc/kubernetes/pki/etcd/server.crt" --key="/etc/kubernetes/pki/etcd/server.key" member remove <1ì—´ì˜IDê°’>
```

- initì„ í–ˆì§€ë§Œ, endpointê°€ ì•ˆë¬¼ë ¤ì„œ api healthyì—ì„œ ë¨¸ë¬´ëŠ” ê²½ìš°
  ê¸°ì¡´ `path: /etc/kubernetes/admin.conf`ë¥¼ `path: /etc/kubernetes/super-admin.conf`ë¡œ ë³€ê²½í•˜ì—¬ inití•œ í›„ì— ë‹¤ì‹œ `path: /etc/kubernetes/admin.conf`ë¡œ ë³€ê²½í•´ì£¼ì–´ì„œ í•´ê²°í•œë‹¤.
```bash title:"/etc/kubernetes/manifests/kube-vip.yaml"
  volumes:
  - hostPath:
      path: /etc/kubernetes/super-admin.conf # ê¸°ì¡´ admin.confì—ì„œ ë³€ê²½í•˜ì—¬ initì‹¤í–‰
    name: kubeconfig
status: {}
```

### Master Nodeë¡œ Joiní•˜ê¸°
#### controlPlaneEndpoint í•­ëª© ì¶”ê°€
- ì•„ë˜ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
```bash
kubectl get configmap kubeadm-config -n kube-system -o yaml > kubeadm-config.yaml
```

- `kubeadm-config.yaml`íŒŒì¼ì— ì•„ë˜ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
```yaml
apiVersion: kubeadm.k8s.io/v1beta3
data:
  ClusterConfiguration:
    controlPlaneEndpoint: "192.168.1.100:6443" # ì˜ˆì‹œ: í˜„ì¬ ë§ˆìŠ¤í„° IP, VIP ì‚¬ìš©ì‹œ vip-ip
kind: ClusterConfiguration
...
```

- ìˆ˜ì •í•œ ë‚´ìš©ì„ ì ìš©ì‹œí‚µë‹ˆë‹¤.
```bash
kubectl apply -f kubeadm-config.yaml
```

#### join ëª…ë ¹ì–´
```bash
kubeadm join <MASTER_IP>:<PORT> --token <TOKEN> \
    --discovery-token-ca-cert-hash sha256:<HASH> \
    --control-plane --certificate-key <CERTIFICATE_KEY>
```

#### certificate-key ë°›ëŠ” ë°©ë²•
```bash
kubeadm init phase upload-certs --upload-certs
```

#### tokenê°’ ì¡°íšŒ
```bash
kubeadm token list
```

#### hashê°’ êµ¬í•˜ëŠ” ë°©ë²•
```bash
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
    openssl rsa -pubin -outform der 2>/dev/null | \
    sha256sum | \
    awk '{print $1}'
```

### Metrics-server ì„¤ì¹˜
## Install
```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

## TroubleShooting
#### ê° ë…¸ë“œì— ì ‘ì†ì‹œ ê¶Œí•œì— ê´€í•œ ë¬¸ì œê°€ ìˆì„ ê²½ìš°
1. `--kubelet-insecure-tls`ì˜µì…˜ì´ ëˆ„ë½ë˜ì–´ httpsì¸ì¦ì„ ë°›ì•„ì•¼í•˜ëŠ” ìƒí™©
    - httpsì¸ì¦ ì—†ì´ ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •
```bash
# ê¸°ë³¸ ì…‹íŒ…
kubectl -n kube-system patch deployment metrics-server \
  --type='json' \
  -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
  
## í•¨ê»˜ ì¶”ê°€í•˜ë©´ ë” ì¢‹ìŒ
kubectl -n kube-system patch deployment metrics-server \
  --type='json' \
  -p='[
    {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"},
    {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-preferred-address-types=InternalIP,Hostname,ExternalIP"}
  ]'
```

```bash
# pod ì¬ì‹œì‘
kubectl rollout restart deployment metrics-server -n kube-system
```

---
## TroubleShooting
### iptables ì´ˆê¸°í™”
```bash
# Filter í…Œì´ë¸” ì´ˆê¸°í™”
sudo iptables -F
sudo iptables -X

# NAT í…Œì´ë¸” ì´ˆê¸°í™”
sudo iptables -t nat -F
sudo iptables -t nat -X

# Mangle í…Œì´ë¸” ì´ˆê¸°í™”
sudo iptables -t mangle -F
sudo iptables -t mangle -X

# Raw í…Œì´ë¸” ì´ˆê¸°í™”
sudo iptables -t raw -F
sudo iptables -t raw -X

# ê¸°ë³¸ ì •ì±…ì„ ACCEPTìœ¼ë¡œ ë³€ê²½ (ì•ˆí•˜ë©´ SSH ëŠê¸¸ ìˆ˜ ìˆìŒ)
sudo iptables -P INPUT ACCEPT
sudo iptables -P FORWARD ACCEPT
sudo iptables -P OUTPUT ACCEPCNI_PLUGINS_VERSION="v1.1.1"
```

### /etc/cni/net.dí´ë”ë¥¼ ì°¸ì¡°í•˜ì§€ ì•Šì„ ê²½ìš°
1. ciliumì„ ë‹¤ì‹œ ì˜¬ë ¤ë³¸ë‹¤.
```bash
kubectl -n kube-system delete pods -l k8s-app=cilium
```